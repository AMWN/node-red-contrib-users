<style>
.node-users-config-wrapper {
  margin: 20px;
}
.node-users-config-wrapper select, 
.node-users-config-wrapper input {
  width: 100%;
  margin-bottom: 0;
}
.node-users-config-wrapper label {
  font-weight: bold;
}
.node-input-users-container-row > ul {
  list-style: none;
  width: 100%;
  height: 240px;
  overflow-y: scroll;
  overflow-x: hidden;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
  display: inline-block;
  margin: 0;
  vertical-align: top;
}
.node-input-users-container-row > ul > li {
  margin: 0 5px;
  border-bottom: 1px solid #ccc;
  position: relative;
  padding: 10px 5px;
}
.node-input-users-container-row > ul > li > span {
  display: inline-block;
}
.node-input-users-container-row > ul > li > span.users-username {
}
.node-input-users-container-row > ul > li > span.users-role {
  margin-left: 5px;
  color: #999;
}
.node-input-users-container-row > ul > li > a {
  float: right;
}
.node-input-add-users-container-row {
}
#node-input-add-option {
  margin-top: 10px;
}
#generate-jwt-secret i,
#node-input-add-option i {
  vertical-align: middle;
  margin-right: 5px;
}
#generate-jwt-secret {
  margin-top: 7px;
}
</style>

<script type="text/x-red" data-template-name="users_config">
  <div class='form-row'>
    <a href="#" onclick="RED.sidebar.show('nodeUsers'); $('#node-config-dialog-cancel').click(); return false" class="editor-button">Open node users</a>
  </div>

</script>


<script type="text/javascript">
  RED.nodes.registerType('users_config', {
    category: 'config',
    defaults: {
      name: {value: ""},
      jwtSecret: {value: ""},
      nodeUsers: {value: []}
    },
    hasUsers: false,
    plaetteLabel: 'Node Users',
    label: function () {
      return this.name || "Node users";
    },
    onpaletteremove: function() {
        RED.sidebar.removeTab("nodeUsers");
        RED.events.off("editor:save",editSaveEventHandler);
    },
    onpaletteadd: function () {
      var globalUserConfigNode = null;

      var content = $("<div>", {class: "node-users-config-wrapper"});

      var title = $("<h4>").text("Node Users Configuration").appendTo(content);

      var jwtForm = $("<div>", {class: "form-row"}).appendTo(content);
      var jwtLabel = $("<label>", {for: "node-config-input-jwtSecret"}).text("JWT secret").appendTo(jwtForm);
      var jwtInput = $("<input>", {type: "text", id: "node-config-input-jwtSecret", "placeholder": "JWT secret"}).appendTo(jwtForm);
      var jwtGenerateBtn = $("<button>", {id: "generate-jwt-secret", class: "editor-button editor-button-small"}).text("Regenerate secret").appendTo(jwtForm);
      var jwtGenerateBtnIcon = $("<i>", {class: "fa fa-refresh"}).prependTo(jwtGenerateBtn);

      var alertInfo = $("<div>", {class: "form-row alert alert-info"}).text("Create a list of users who are authorized.").appendTo(content);
      var nodeUsersContainer = $("<div>", {class: "form-row node-input-users-container-row"}).appendTo(content);
      var nodeUsersList = $("<ul>").appendTo(nodeUsersContainer);

      var usernameForm = $("<div>", {class: "form-row"}).appendTo(content);
      var usernameLabel = $("<label>", {for: "node-config-input-users-username"}).text("Username").appendTo(usernameForm);
      var usernameInput = $("<input>", {type: "text", id: "node-config-input-users-username", "placeholder": "Username"}).appendTo(usernameForm);
      
      var passwordForm = $("<div>", {class: "form-row"}).appendTo(content);
      var passwordLabel = $("<label>", {for: "node-config-input-users-password"}).text("Password").appendTo(passwordForm);
      var passwordInput = $("<input>", {type: "text", id: "node-config-input-users-password", "placeholder": "Password"}).appendTo(passwordForm);
      

      var roleForm = $("<div>", {class: "form-row"}).appendTo(content);
      var roleLabel = $("<label>", {for: "node-config-input-users-role"}).text("User Role").appendTo(roleForm);
      var roleInput = $("<select>", {id: "node-config-input-users-role"}).appendTo(roleForm);
      var roleOptionsUser = $("<option>", {value: "user", selected: "selected"}).text("User").appendTo(roleInput);
      var roleOptionsAdmin = $("<option>", {value: "admin"}).text("Admin").appendTo(roleInput);
    
      var addUserBtn = $("<a>", {href: "#", class: "editor-button", id: "node-input-add-option"}).appendTo(content);
      var addUserBtnIcon = $("<i>", {class: "fa fa-plus"}).appendTo(addUserBtn);
      var addUserBtnText = $("<span>").text("Add user to whitelist").appendTo(addUserBtn);

      function getNodeUsers() {
        var nodeUsers = [];
        $(".node-input-users-container-row > ul > li").each(function () {
          var item = $(this);
          nodeUsers.push({
            username: item.data('username').toString(),
            password: item.data("hash").toString(),
            role: item.data("role")
          });
        });
        return nodeUsers;
      }

      function save() {
        var jwtSecret = $("#node-config-input-jwtSecret").val();
        var nodeUsers = getNodeUsers();
        // If there is no config node, ensure we create it after initialising
        if (globalUserConfigNode === null) {
          globalUserConfigNode = {
            id: RED.nodes.id(),
            _def: RED.nodes.getType("users_config"),
            type: "users_config",
            jwtSecret: jwtSecret,
            nodeUsers: nodeUsers,
            users: []
          }
          RED.nodes.add(globalUserConfigNode);
        } else {
          globalUserConfigNode["_def"] = RED.nodes.getType("users_config");
          globalUserConfigNode.jwtSecret = jwtSecret;
          globalUserConfigNode.nodeUsers = nodeUsers;
          delete globalUserConfigNode.name;
        }
        RED.nodes.dirty(true);
      }

      function initUsersConfigNode() { // Behaviour based on node-red-dashboard
        if (globalUserConfigNode !== null) {
          // Check if it has been deleted beneath us
          var n = RED.nodes.node(globalUserConfigNode.id);
          if (n === null) {
            globalUserConfigNode = null;
          }
        }
        // Find the old config node
        if (globalUserConfigNode === null) {
          var bases = [];
          RED.nodes.eachConfig(function(n) {
            if (n.type === 'users_config') {
              bases.push(n);
            }
          });
          // make sure we only have one users_config node
          while (bases.length > 1) {
            var n = bases.pop();
            RED.nodes.remove(n.id);
            RED.nodes.dirty(true);
          }
          if (bases.length === 1) {
            globalUserConfigNode = bases[0];
          }

          if (globalUserConfigNode !== null) {
            globalUserConfigNode.nodeUsers.forEach(function (u) {
              renderUserRow(u);
            });
            $("#node-config-input-jwtSecret").val(globalUserConfigNode.jwtSecret);  
          }

          if ($("#node-config-input-jwtSecret").val() === "") {
            $("#node-config-input-jwtSecret").val(generateJwtSecret());
            save();
          }
        }
      }

      function generateJwtSecret() {
        var len = 32;
        var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var secret = '';
        for (var i = len; i > 0; --i) {
          secret += chars[Math.floor(Math.random() * chars.length)]
        };
        return secret;
      }

      function renderUserRow(user) {
        var listItem = $("<li />", {
          "data-username": user.username, 
          "data-role": user.role, 
          "data-hash": user.password
        });
        var username = $("<span />", {"class": "users-username"}).appendTo(listItem);
        var role = $("<span />", {"class": "users-role"}).appendTo(listItem);
        var deleteBtn = $("<a />", {href:"#", class: "editor-button editor-button-small"}).appendTo(listItem);
        var ico = $("<i />", {class: "fa fa-remove"}).appendTo(deleteBtn);
        username.text(user.username);
        role.text("("+user.role+")");
        nodeUsersList.append(listItem);
      }

      function userExists(username) {
        var nodeUsersList = $(".node-input-users-container-row > ul > li");
        var exists = nodeUsersList.filter(function () {
          return $(this).data("username") === username;
        }).length > 0;
        return exists;
      }

      $(document).on("click", ".node-input-users-container-row > ul > li > a", function () {
        var username = $(this).parents("li").data('username');
        $(".node-input-users-container-row > ul > li").each(function () {
          if ($(this).data("username") === username) {
            $(this).remove();
            save();
          }
        });
      });

      $(document).on("click", "#node-input-add-option", function () {
        var user = {
          username: $("#node-config-input-users-username").val(),
          password: $("#node-config-input-users-password").val(),
          role: $("#node-config-input-users-role").val()
        };
        if (user.username === "" || user.password === "") {
          RED.notify("Username and password fields are required.", "error");
          return;
        }
        if (userExists(user.username) === true) {
          RED.notify("User with username \""+user.username+"\" already exist in the list.", "error");
          return;
        }
        $("#node-config-input-users-username").val("");
        $("#node-config-input-users-password").val("");
        $("#node-config-input-users-role").val("user");

        renderUserRow(user);
        save();
      });

      $(document).on("blur", "#node-config-input-jwtSecret", function () {
        if ($(this).val() === "") {
          $("#node-config-input-jwtSecret").val(generateJwtSecret());
        }
        save(); 
      });

      $(document).on("click", "#generate-jwt-secret", function () {
        $("#node-config-input-jwtSecret").val(generateJwtSecret());
        save();
      });

      RED.sidebar.addTab({
        id: "nodeUsers",
        label: "node users",
        name: "Node users",
        content: content,
        closeable: true,
        disableOnEdit: true,
        onchange: function() { 
          initUsersConfigNode();
        }
      });
    },
  });
</script>
